<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classeur Num√©rique</title>

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Nouveau fond : Gris chaud / Taupe clair */
            background: #e6e0d8; 
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .session-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        .session-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .quill-editor-container {
            background: white;
            height: 150px;
            margin-bottom: 15px;
        }
        .ql-editor {
            min-height: 100px;
        }

        /* Force la visibilit√© des ic√¥nes Quill */
        .ql-snow .ql-stroke {
            stroke: #333 !important; stroke-width: 2px;
        }
        .ql-snow .ql-fill {
            fill: #333 !important;
        }
        .ql-snow .ql-picker {
            color: #333 !important; font-weight: bold;
        }

        /* Conteneur pour l'√©dition des cours */
        .course-editor-container {
            background: white;
            height: 250px; /* Plus grand pour le confort */
            margin-bottom: 10px;
        }

        /* Am√©lioration de la barre d'outils */
        .ql-toolbar.ql-snow {
            background: #f8f9fa !important;
            border-color: #ccc !important;
        }
        
        .ql-container.ql-snow {
            border: 1px solid #ccc !important;
            background: white;
            border-radius: 0 0 5px 5px;
        }    

/* Effet au survol des boutons */
        .ql-snow.ql-toolbar button:hover .ql-stroke {
            stroke: #007bff !important;
        }
        
        .header {
            background: linear-gradient(135deg, #a9a9aa 0%, #222224 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls {
            background: rgb(229, 203, 229);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }

        .class-selector, .period-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        select, button {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        select {
            background: #fff;
            border: 1px solid #ccc;
            min-width: 150px;
        }

        button {
            background: #26283a;
            color: white;
            font-weight: 600;
        }

        button:hover:not([disabled]) {
            background: #26283a;
        }

        button[disabled] {
            background: #ccc;
            cursor: not-allowed;
        }

        .period-nav button {
            width: 40px;
            padding: 10px 5px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            padding: 5px;
        }

        .week-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .week-header {
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #495057;
        }

        .week-type {
            font-size: 0.8em;
            background: #e9ecef;
            padding: 2px 5px;
            border-radius: 4px;
        }

        .course-slot, .notes-slot {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border-left: 5px solid #667eea;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            min-height: 150px;

            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .course-slot:hover, .notes-slot:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        .course-date {
            font-size: 0.85em;
            color: #5a4b81;
            margin-bottom: 8px;
            font-style: italic;
            font-weight: 600;  /* Un peu plus √©pais */
            display: block;
            border-bottom: 1px solid #f0f0f0; /* Petite s√©paration discr√®te */
            padding-bottom: 3px;
        }

        .course-content, .course-homework, .course-notes {
            font-size: 0.9em;
            color: #343a40;
            margin-top: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            line-height: 1.4; /* Am√©liore la lisibilit√© */
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal.active {
            display: block;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px; /* Taille augment√©e */
            width: 95%;
            max-height: 95vh;
            overflow-y: auto;
            margin: 2% auto; 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); 
            animation: slide-down 0.3s ease-out;
        }
        
        @keyframes slide-down {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .close-btn {
            background: #dc3545;
            color: white;
            padding: 8px 12px;
        }
        
        .close-btn:hover {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #343a40;
        }

        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group input[type="text"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .form-group textarea {
            min-height: 120px; /* Hauteur minimale augment√©e */
            resize: vertical;
        }

        .save-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            font-weight: bold;
            width: 100%;
        }

        .save-btn:hover {
            background: #218838;
        }
        
        /* List Management Styles */
        .list-management {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .class-item, .sequence-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px dotted #ccc;
        }
        
        .class-item:last-child, .sequence-item:last-child {
            border-bottom: none;
        }
        
        .class-info {
            flex-grow: 1;
        }

        .class-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .class-pattern {
            font-size: 0.9em;
            color: #6c757d;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.9em;
            margin-left: 5px;
        }
        
        .btn-delete {
            background: #dc3545;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .edit-btn {
             background: #ffc107;
             color: #333;
        }
        
        .edit-btn:hover {
             background: #e0a800;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }

        /* √âgalise la hauteur du champ de texte et du s√©lecteur de niveau */
        #sequenceLevel, 
        #sequenceName {
            height: 42px; /* Hauteur standard confortable */
            padding: 8px 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Important pour que le padding ne d√©forme pas la taille */
        }

        /* Optionnel : ajouter un petit effet au focus pour le c√¥t√© "pro" */
        #sequenceName:focus, 
        #sequenceLevel:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 5px rgba(0,123,255,0.2);
        }
        
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
</head>

<body>

<div id="auth-section" style="padding: 50px; text-align: center; max-width: 400px; margin: 100px auto; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
    <h2>Acc√®s au Classeur Num√©rique</h2>
    <p>Veuillez vous connecter pour acc√©der √† vos donn√©es s√©curis√©es.</p>
    
    <div class="form-group mb-2">
        <input type="email" id="auth-email" placeholder="Adresse E-mail" class="form-control" style="width: 100%; padding: 8px; margin-bottom: 10px;">
    </div>
    <div class="form-group mb-3">
        <input type="password" id="auth-password" placeholder="Mot de passe" class="form-control" style="width: 100%; padding: 8px; margin-bottom: 15px;">
    </div>
    
    <button onclick="signIn()" class="btn btn-primary" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Se connecter</button>
    <button onclick="signUp()" class="btn btn-success" style="margin-left: 10px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">S'inscrire</button>
</div>

<div id="app-section" style="display: none;">
    <div class="container">
        <div class="header">
            <h1>üìö Classeur Num√©rique P√©dagogique</h1>
        </div>

        <div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div>
                <label for="yearSelect">Ann√©e :</label>
                <select id="yearSelect" onchange="changeYear(this.value)">
                    <option value="2025-2026">2025-2026</option>
                    <option value="2026-2027">2026-2027</option>
                    <option value="2027-2028">2027-2028</option>
                </select> 
            </div>

            <div class="class-selector">
                <label for="classSelect">Classe :</label>
                <select id="classSelect"></select>
                <button onclick="openClassManager()">G√©rer les classes</button>
                <button onclick="openSequenceManager()" style="background: #6f42c1; color: white;">Catalogue S√©quences</button>
            </div>
            
            <div class="period-nav">
                <button id="prevPeriod">‚Üê</button>
                <span id="periodInfo" style="font-weight: bold;">P√©riode 1</span>
                <button id="nextPeriod">‚Üí</button>
            </div>
            
            <button onclick="openExportModal()">Importer/Exporter</button>
        </div>

            <button onclick="exportToPDF()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
    üìï T√©l√©charger le PDF
            </button>
        
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
    
    <div class="modal" id="courseModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>√âditer le cours</h2>
                <button class="close-btn" onclick="closeCourseModal()">Fermer</button>
            </div>
            <form id="courseForm" onsubmit="event.preventDefault(); saveCourse();">
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 150px;">
                        <label>Niveau</label>
                        <select id="courseLevelSelect" onchange="renderCourseSequenceSelect()" style="width: 100%;"></select>
                    </div>
                    <div style="flex: 2; min-width: 200px;">
                        <label>S√©quence</label>
                        <select id="courseSequenceSelect" onchange="renderCourseSessionSelect()" style="width: 100%;"></select>
                    </div>
                    <div style="flex: 2; min-width: 200px;">
                        <label>S√©ance</label>
                        <select id="courseSessionSelect" onchange="applySessionContent()" style="width: 100%;"></select>
                    </div>
                    <div style="flex: 1; min-width: 100px;">
                        <label>N¬∞ S√©ance</label>
                        <input type="number" id="courseSessionNum" min="1" value="1" style="width: 100%;">
                    </div>
                </div>

                <div class="form-group">
                    <label>Date du cours</label>
                    <input type="date" id="courseDate" required>
                    <div id="syncStatus" style="float: right; font-size: 0.8em; color: #666;">
                        <span id="syncDot" style="width: 8px; height: 8px; background-color: #4caf50; border-radius: 50%; display: inline-block; margin-right: 5px;"></span>
                        <span id="syncText">Synchronis√©</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Contenu du cours</label>
                    <div id="courseContentQuill" style="height: 200px; background: white;"></div>
                </div>
                
                <div class="form-group">
                    <label>Travail √† faire</label>
                    <div id="courseHomeworkQuill" style="height: 120px; background: white;"></div>
                </div>
                
                <div class="form-group">
                    <label>Notes personnelles</label>
                    <textarea id="courseNotes" rows="3" placeholder="Remarques priv√©es..."></textarea>
                </div>
                
                <button type="submit" class="save-btn" style="width: 100%; padding: 15px; font-size: 1.1em;">üíæ Enregistrer le cours</button>
            </form>
        </div>
    </div>

    <div class="modal" id="sequenceModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>Catalogue des S√©quences P√©dagogiques</h2>
                <button class="close-btn" onclick="closeSequenceManager()">Fermer</button>
            </div>
            
            <div class="list-management">
                <h4>S√©quences existantes</h4>
                <div id="sequenceList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px;"></div>
            </div>
            
            <hr>
            
            <div id="sequenceForm"> <h4>Ajouter / Modifier une S√©quence</h4>
    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
        <div style="flex: 1;">
            <label>Niveau de Classe</label>
           <select id="sequenceLevel" style="width: 100%;" onchange="renderSequenceLevelList()">
                <option value="">-- Niveau --</option>
                <option value="6">6√®me</option>
                <option value="5">5√®me</option>
                <option value="4">4√®me</option>
                <option value="3">3√®me</option>
            </select>
        </div>
        <div style="flex: 3;">
            <label>Nom de la S√©quence (Th√®me)</label>
            <input type="text" id="sequenceName" style="width: 100%;"> </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <label><strong>S√©ances de la S√©quence</strong></label>
        <button type="button" class="btn-small" style="background: #28a745; color: white;" onclick="addSessionToSequence()">+ Ajouter S√©ance</button>
    </div>

    <div id="sequenceSessionsList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 15px; background: #f1f1f1; border-radius: 5px;">
        <div style="color: #999; text-align: center;">Aucune s√©ance.</div>
    </div>
    
    <button type="button" class="save-btn" onclick="addSequence()" style="margin-top: 20px;">üíæ Enregistrer la S√©quence Compl√®te</button>
</div>
        </div>
    </div>

    <div class="modal" id="classModal">
        <div class="modal-content">
            <div class="modal-header"><h2>G√©rer les Classes</h2><button class="close-btn" onclick="closeClassManager()">Fermer</button></div>
            <form onsubmit="event.preventDefault(); addClass();">
                <h4>Ajouter une classe</h4>
                <input type="text" id="className" placeholder="Nom de la classe (ex: 3¬∞4)" required style="margin-bottom: 10px;">
                <div style="margin-bottom: 15px;">
                    <label><input type="radio" name="weekPattern" value="3-2" checked> 3 cours A / 2 cours B</label><br>
                    <label><input type="radio" name="weekPattern" value="2-3"> 2 cours A / 3 cours B</label>
                </div>
                <button type="submit" class="save-btn">‚ûï Ajouter</button>
            </form>
            <div id="classList" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div class="modal" id="notesModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Notes de la semaine</h2><button class="close-btn" onclick="closeNotesModal()">Fermer</button></div>
            <form id="notesForm" onsubmit="event.preventDefault(); saveWeekNotes();">
                <textarea id="weekNotes" rows="10" style="width: 100%;"></textarea>
                <button type="submit" class="save-btn" style="margin-top: 10px;">üíæ Enregistrer les notes</button>
            </form>
        </div>
    </div>

    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Importer / Exporter</h2><button class="close-btn" onclick="closeExportModal()">Fermer</button></div>
            <button onclick="exportData()" class="save-btn" style="background: #007bff; margin-bottom: 20px;">‚¨áÔ∏è T√©l√©charger la sauvegarde (.json)</button>
            <hr>
            <h4>Importer</h4>
            <input type="file" id="importFile" accept=".json" style="margin: 10px 0;">
            <button onclick="importData()" class="save-btn" style="background: #ffc107; color: #333;">‚¨ÜÔ∏è Importer (√âcrase tout)</button>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px; padding-bottom: 40px;">
        <button onclick="resetData()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">R√©initialiser l'Ann√©e</button>
        <button onclick="signOutUser()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">D√©connexion</button>
    </div>
</div>    
    <script>
// =========================================================
// Configuration Firebase (V√©rifiez la ligne databaseURL)
// =========================================================
const firebaseConfig = {
    apiKey: "AIzaSyA4BpxaadwjKgiJH3rwOdk3WaJ9m5G9qqw",
    authDomain: "suivi-classe-4eme.firebaseapp.com",
    projectId: "suivi-classe-4eme",
    storageBucket: "suivi-classe-4eme.firebasestorage.app",
    messagingSenderId: "1088897454236",
    appId: "1:1088897454236:web:273a6ddf50ab9c0b605d59",
    databaseURL: "https://suivi-classe-4eme-default-rtdb.europe-west1.firebasedatabase.app" 
};

// Initialiser Firebase si ce n'est pas d√©j√† fait
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();
const auth = firebase.auth(); 

let userId = null; 

// ‚úÖ SOLUTION : Attendre que le DOM soit charg√©
document.addEventListener('DOMContentLoaded', () => {
    
    // √âcouteur d'√©tat de connexion
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            const monEmailPerso = "sophie.durand@free.fr";

            if (user.email.toLowerCase() !== monEmailPerso.toLowerCase()) {
                console.log("Compte enseignant d√©tect√©. D√©connexion forc√©e pour permettre l'acc√®s admin.");
                
                firebase.auth().signOut().then(() => {
                    alert("Compte non autoris√© pour cet outil. Veuillez vous connecter avec votre compte administrateur.");
                    
                    // ‚úÖ Ces √©l√©ments existent maintenant
                    const authSection = document.getElementById('auth-section');
                    const calendarSection = document.getElementById('calendar-section');
                    
                    if (authSection) authSection.style.display = 'block';
                    if (calendarSection) calendarSection.style.display = 'none';
                });
                return;
            }

            // Si c'est bien VOUS
            console.log("Acc√®s Admin accord√©");
            userId = user.uid;
            console.log(`Utilisateur connect√© : ${user.email} UID: ${userId}`);
            
            // ‚úÖ V√©rification avant manipulation
            const authSection = document.getElementById('auth-section');
            const calendarSection = document.getElementById('calendar-section');
            
            if (authSection) authSection.style.display = 'none';
            if (calendarSection) calendarSection.style.display = 'block';
            
            loadData().then(() => { renderCalendar(); });

        } else {
            // Personne n'est connect√©
            console.warn("Utilisateur non d√©tect√©.");
            
            const authSection = document.getElementById('auth-section');
            const calendarSection = document.getElementById('calendar-section');
            
            if (authSection) authSection.style.display = 'block';
            if (calendarSection) calendarSection.style.display = 'none';
        }
    });
    
}); // Fin du DOMContentLoaded

// =========================================================
// √âtat de l'application
// =========================================================
let state = {
    currentYearId: '2025-2026',
    currentClass: '',
    currentPeriod: 1,
    classes: [],
    courses: {},
    weekNotes: {},
    sequences: {}
};

let currentEditingCourse = null;
let currentEditingWeek = null;
let currentEditingSequenceIndex = null;
let currentEditingLevel = null;
let tempSessions = [];

// --- AJOUTEZ CES LIGNES ICI ---
let courseContentEditor; // Variable pour l'√©diteur de contenu du journal
let courseHomeworkEditor; // Variable pour l'√©diteur de devoirs du journal

// Configuration de la barre d'outils riche (utilis√©e par TOUS les √©diteurs)
const fullToolbarOptions = [
    ['bold', 'italic', 'underline'],
    [{ 'color': [] }, { 'background': [] }], // Palette de couleurs
    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
    ['clean'] // Bouton pour effacer le formatage
];
// ------------------------------

// --- FONCTION DE SAUVEGARDE ---
function saveData() {
    if (!userId) return;
    const year = state.currentYearId || "2024-2025";
    const path = 'classeurData/' + userId + '/' + year;

    db.ref(path).set(state)
        .then(() => console.log("Sauvegarde r√©ussie dans :", path))
        .catch((error) => console.error("Erreur sauvegarde :", error));
}

function exportToPDF() {
    if (typeof html2pdf === 'undefined') {
        alert("La biblioth√®que PDF n'est pas charg√©e.");
        return;
    }

    const element = document.createElement('div');
    
    // --- STYLE G√âN√âRAL ET CORRECTIF LISTES ---
    element.innerHTML = `
        <style>
    .pdf-container { font-family: Arial, sans-serif; padding: 20px; color: #333; }
    .pdf-title { text-align: center; color: #2c3e50; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 30px; }
    .course-card { border: 1px solid #eee; border-radius: 8px; margin-bottom: 30px; overflow: hidden; page-break-inside: avoid; }
    .course-header { background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #667eea; display: flex; justify-content: space-between; align-items: center; }
    .course-body { padding: 15px 30px; } 
    .course-meta { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #ddd; font-size: 0.95em; color: #555; }
    
    /* CORRECTIF LISTES NUM√âROT√âES ET PUCES */
    .content-area ol { list-style-type: decimal !important; margin-left: 35px !important; padding-left: 0 !important; }
    .content-area ul { list-style-type: disc !important; margin-left: 35px !important; padding-left: 0 !important; }
    .content-area li { display: list-item !important; margin-bottom: 5px; padding-left: 5px; }

    /* Gestion des couleurs et surlignages de Quill */
    .content-area span[style*="background-color"] { padding: 2px 4px; border-radius: 2px; }
    
    .homework-box { margin-top: 15px; padding: 10px 15px; background: #fffdf0; border-left: 4px solid #f1c40f; font-size: 0.9em; }
    .homework-box ol, .homework-box ul { margin-left: 25px !important; }
    </style>
        <div class="pdf-container">
            <h1 class="pdf-title">Journal de Bord P√©dagogique</h1>
            <div id="pdf-content"></div>
        </div>
    `;

    const contentTarget = element.querySelector('#pdf-content');
    const sortedKeys = Object.keys(state.courses).sort();

    sortedKeys.forEach(key => {
        const course = state.courses[key];
        
        // 1. Date au format Fran√ßais
        let dateAffichage = key;
        if (course.date) {
            const [year, month, day] = course.date.split('-');
            dateAffichage = `${day}/${month}/${year}`;
        }
        
        // 2. Classe propre (on prend ce qui est avant le premier tiret)
        const classePropre = key.split('-')[0];

        contentTarget.innerHTML += `
            <div class="course-card">
                <div class="course-header">
                    <span style="font-weight: bold; color: #667eea;">üìÖ ${dateAffichage}</span>
                    <span style="font-weight: bold; color: #2c3e50;">Classe : ${classePropre}</span>
                </div>
                <div class="course-body">
                    <div class="course-meta">
                        <strong>S√©quence :</strong> ${course.sequence || 'Non d√©finie'} <br>
                        <strong>S√©ance n¬∞ :</strong> ${course.sessionNum || '1'}
                    </div>
                    <div class="content-area">
                        <div style="margin-bottom: 10px; font-weight: bold; color: #2c3e50;">Contenu du cours :</div>
                        ${course.content || "<i>Aucun contenu.</i>"}
                    </div>
                    ${course.homework && course.homework !== '<p><br></p>' ? `
                        <div class="homework-box">
                            <strong>üè† Devoirs :</strong><br>${course.homework}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });

    const opt = {
        margin: [10, 10],
        filename: 'Journal_de_Bord.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, letterRendering: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(opt).from(element).save();
}
        
// --- FONCTION DE CHARGEMENT ---
function loadData() {
    if (!userId) {
        console.warn("Utilisateur non d√©tect√©.");
        return Promise.resolve();
    }

    const year = state.currentYearId || "2024-2025";
    const path = 'classeurData/' + userId + '/' + year;

    console.log("Tentative de chargement :", path);

    return db.ref(path).once('value')
        .then((snapshot) => {
            const data = snapshot.val();
            
            if (data) {
                state = { ...state, ...data };
                console.log("Donn√©es charg√©es !");
            } else {
                console.log("Dossier vide. Initialisation par d√©faut...");
                state.classes = [
                    { id: '3-3', name: '3¬∞3', pattern: '3-2' },
                    { id: '4-2', name: '4¬∞1', pattern: '3-2' },
                    { id: '5-3', name: '5¬∞1', pattern: '3-2' },
                    { id: '4-4', name: '6¬∞1', pattern: '3-2' }
                ];
                state.currentClass = state.classes[0].id;
                state.sequences = {};
                saveData(); 
            }

            if (!state.currentClass && state.classes && state.classes.length > 0) {
                state.currentClass = state.classes[0].id;
            }
            return true; 
        })
        .catch((error) => {
            console.error("Erreur Firebase :", error);
            return false;
        });
}// --- Apr√®s la fin de loadData ---

async function changeYear(newYearId) {
    // 1. On met √† jour l'ann√©e dans l'√©tat
    state.currentYearId = newYearId;
    
    // 2. On vide les donn√©es actuelles de l'affichage pour √©viter les m√©langes
    state.classes = [];
    state.courses = {};
    state.weekNotes = {};
    state.currentClass = '';
    // Note: on peut choisir de garder ou non les s√©quences (catalogue commun)
    // state.sequences = {}; 

    console.log("Bascule vers l'ann√©e : " + newYearId);

    // 3. On recharge les donn√©es de cette nouvelle ann√©e
    await loadData();
    
    // 4. On redessine toute l'interface
    updateClassSelect();
    updatePeriodInfo();
    renderCalendar();
    
    // Optionnel : message de confirmation
    console.log("Affichage mis √† jour pour " + newYearId);
}
// <--- V√âRIFIEZ BIEN QU'IL N'Y A PAS DE "RETURN" JUSTE APR√àS CETTE LIGNE

        // =========================================================
// GESTION DE L'√âTAT DE CONNEXION
// =========================================================

function handleAuthStateChange(user) {
    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');

    if (user) {
        // 1. UTILISATEUR CONNECT√â
        userId = user.uid; // Utilise l'UID unique de l'utilisateur comme chemin
        authSection.style.display = 'none'; // Masquer la connexion
        appSection.style.display = 'block'; // Afficher l'application

        loadData(); // Charger les donn√©es de cet utilisateur sp√©cifique
        console.log("Utilisateur connect√© :", user.email, "UID:", userId);
        
        // Initialiser l'interface de l'application
        init(); 

    } else {
        // 2. UTILISATEUR D√âCONNECT√â
        userId = null;
        authSection.style.display = 'block'; // Afficher la connexion
        appSection.style.display = 'none'; // Masquer l'application
        console.log("Utilisateur d√©connect√©.");
    }
}


// L'√©couteur Firebase qui surveille la connexion/d√©connexion
auth.onAuthStateChanged(handleAuthStateChange);
        // ------------------------------------------------------------------

        // Initialiser l'application
      // ------------------------------------------------------------------
        // NOUVELLE FONCTION : Initialiser l'application
        // ------------------------------------------------------------------
        async function init() {
            await loadData(); // <-- Attendre que les donn√©es Firebase soient charg√©es

            // --- √âTAPE 1 : INITIALISATION DES √âDITEURS QUILL (AJOUT ICI) ---
            // On initialise les √©diteurs du journal de bord une seule fois au d√©marrage
            // Emp√™che la cr√©ation multiple si init() est rappel√©
        if (!courseContentEditor) {
            courseContentEditor = new Quill('#courseContentQuill', {
                theme: 'snow',
                modules: { toolbar: fullToolbarOptions }
            });
        }

        if (!courseHomeworkEditor) {
            courseHomeworkEditor = new Quill('#courseHomeworkQuill', {
                theme: 'snow',
                modules: { toolbar: fullToolbarOptions }
            });
        }
    // ---------------------------------------------------------------
            
            // Tout ce qui suit est ex√©cut√© APR√àS le chargement de Firebase
            updateClassSelect();
            updatePeriodInfo();
            renderCalendar();
            updateNavigationButtons();

            // Event listeners
            document.getElementById('classSelect').addEventListener('change', (e) => {
                state.currentClass = e.target.value;
                state.currentPeriod = 1;
                renderCalendar();
                updateNavigationButtons();
                updatePeriodInfo();
                saveData();
            });

           // Pour le bouton Pr√©c√©dent

            
const btnPrev = document.getElementById('prevPeriod');
btnPrev.replaceWith(btnPrev.cloneNode(true)); // On "nettoie" les anciens √©couteurs
document.getElementById('prevPeriod').addEventListener('click', () => {
    let p = parseInt(state.currentPeriod);
    if (p > 1) {
        state.currentPeriod = p - 1;
        renderCalendar();
        updateNavigationButtons();
        updatePeriodInfo();
        saveData();
    }
});

// Pour le bouton Suivant
const TOTAL_PERIODES = 10;            
const btnNext = document.getElementById('nextPeriod');
btnNext.replaceWith(btnNext.cloneNode(true)); // On "nettoie" les anciens √©couteurs
document.getElementById('nextPeriod').addEventListener('click', () => {
    let p = parseInt(state.currentPeriod);
    if (p < 10) { // On remet √† 5 si vous fonctionnez par p√©riodes de vacances
        state.currentPeriod = p + 1;
        renderCalendar();
        updateNavigationButtons();
        updatePeriodInfo();
        saveData();
    }
});

            document.getElementById('courseForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveCourse();
            });

            document.getElementById('notesForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveWeekNotes();
            });
            
            const sequenceForm = document.getElementById('sequenceForm');
            if (sequenceForm) {
                sequenceForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    addSequence();
                });
            }
        }
        // Code pour le t√©moin lumineux d'enregistrement des donn√©es sur firebase
        function updateSyncUI(status) {
    const dot = document.getElementById('syncDot');
    const text = document.getElementById('syncText');
    
    if (status === 'syncing') {
        dot.style.backgroundColor = '#ff9800'; // Orange
        text.innerText = 'Synchronisation en cours...';
    } else if (status === 'success') {
        dot.style.backgroundColor = '#4caf50'; // Vert
        text.innerText = 'Donn√©es synchronis√©es';
    } else if (status === 'error') {
        dot.style.backgroundColor = '#f44336'; // Rouge
        text.innerText = 'Erreur de connexion !';
    }
}           
        // ------------------------------------------------------------------
            
            // Listener pour le formulaire de s√©quence
            const sequenceForm = document.getElementById('sequenceForm');
            if (sequenceForm) {
                sequenceForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    addSequence();
                });
            }
        

        function updateClassSelect() {
            const select = document.getElementById('classSelect');
            select.innerHTML = state.classes.map(c => 
                `<option value="${c.id}">${c.name}</option>`
            ).join('');
            select.value = state.currentClass;
        }

        function getCurrentClass() {
            return state.classes.find(c => c.id === state.currentClass);
        }

        function updatePeriodInfo() {
            document.getElementById('periodInfo').textContent = `P√©riode ${state.currentPeriod}`;
        }

        function updateNavigationButtons() {
            document.getElementById('prevPeriod').disabled = state.currentPeriod === 1;
            document.getElementById('nextPeriod').disabled = state.currentPeriod === 9;
        }

        function getWeekPattern(weekNumber) {
            const currentClass = getCurrentClass();
            if (!currentClass) return { type: 'A', courses: 3 }; 
            
            const isWeekA = weekNumber % 2 === 1;
            
            const parts = currentClass.pattern ? currentClass.pattern.split('-') : ['3', '2'];
            const [coursesA, coursesB] = parts.map(Number);
            
            return {
                type: isWeekA ? 'A' : 'B',
                courses: isWeekA ? coursesA : coursesB
            };
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            if (state.classes.length === 0) {
                grid.innerHTML = '<div class="empty-state">Veuillez d\'abord ajouter une classe via le bouton "G√©rer les classes".</div>';
                return;
            }

            const startWeek = (state.currentPeriod - 1) * 4 + 1;
            
            for (let week = 0; week < 4; week++) {
                const weekNumber = startWeek + week;
                const weekCard = document.createElement('div');
                weekCard.className = 'week-card';
                
                const pattern = getWeekPattern(weekNumber);
                
                let coursesHTML = '';
                
                let globalCourseNum = 0;
                for (let w = 1; w < weekNumber; w++) {
                    globalCourseNum += getWeekPattern(w).courses;
                }
                
                for (let i = 0; i < pattern.courses; i++) {
                    globalCourseNum++;
                    coursesHTML += renderCourseSlot(weekNumber, i + 1, globalCourseNum);
                }
                
                if (pattern.courses < 3) {
                    coursesHTML += renderNotesSlot(weekNumber);
                }
                
                weekCard.innerHTML = `
                    <div class="week-header">
                        <span>Semaine ${weekNumber}</span>
                        <span class="week-type">Semaine ${pattern.type} (${pattern.courses} cours)</span>
                    </div>
                    ${coursesHTML}
                `;
                
                grid.appendChild(weekCard);
            }
        }

      function renderCourseSlot(week, slotNum, globalNum) {
    const key = `${state.currentClass}-W${week}-C${slotNum}`;
    const course = state.courses[key] || {}; 
    
    let sequenceDisplay = '';
    if (course.sequence) {
        sequenceDisplay = `<strong>S√©quence:</strong> ${course.sequence}`;
        if (course.sessionNum > 0) {
            sequenceDisplay += ` (S√©ance ${course.sessionNum})`;
        }
    }
    
    // Version texte brut pour le homework seulement (pour limiter la hauteur)
    const cleanHomework = course.homework ? course.homework.replace(/<[^>]*>?/gm, '') : '';
    
    // Pour le contenu principal, on conserve le HTML pour afficher le formatage
    const displayContent = course.content || '';
    
    return `
        <div class="course-slot" onclick="editCourse('${key}', ${week}, ${slotNum}, ${globalNum})">
            <h4>Cours ${globalNum}</h4>
            ${course.date ? `<div class="course-date">üìÖ ${formatDate(course.date)}</div>` : '<div class="course-date">‚ö†Ô∏è Date non d√©finie</div>'}
            ${sequenceDisplay ? `<div class="course-content">${sequenceDisplay}</div>` : ''} 
            
            ${course.content ? `<div class="course-content" style="max-height: 120px; overflow: hidden; text-overflow: ellipsis;">${displayContent}</div>` : '<div class="course-content" style="color: #adb5bd;">Cliquez pour ajouter du contenu</div>'}
            
            ${course.homework ? `<div class="course-homework"><strong>üìù √Ä faire:</strong> ${truncate(cleanHomework, 80)}</div>` : ''}
            
            ${course.notes ? `<div class="course-notes"><strong>üí≠ Notes:</strong> ${truncate(course.notes, 80)}</div>` : ''}
        </div>
    `;
}

        function renderNotesSlot(week) {
            const key = `${state.currentClass}-W${week}-NOTES`;
            const notes = state.weekNotes[key] || '';
            
            return `
                <div class="notes-slot" onclick="editWeekNotes('${key}', ${week})">
                    <h4>üìù Notes de la semaine</h4>
                    ${notes ? `<div class="course-content">${truncate(notes, 150)}</div>` : '<div class="course-content" style="color: #999;">Cliquez pour ajouter des notes</div>'}
                </div>
            `;
        }

       function formatDate(dateStr) {
    if (!dateStr) return "";
    
    // On d√©coupe la cha√Æne "2025-09-04" sans laisser le syst√®me l'interpr√©ter
    const parts = dateStr.split('-');
    
    // On cr√©e la date √† MIDI (12h) pour √©viter que le d√©calage 
    // horaire (UTC+1 ou UTC+2) ne fasse basculer le jour.
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1; // Janvier est 0
    const day = parseInt(parts[2]);
    
    const dateObj = new Date(year, month, day, 12, 0, 0);
    
    // On affiche proprement
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    return dateObj.toLocaleDateString('fr-FR', options);
}

        // =========================================================
        // NOUVELLES FONCTIONS DE S√âLECTION EN CASCADE
        // =========================================================
        
        function renderCourseLevelSelect(selectedLevel = '') {
            const select = document.getElementById('courseLevelSelect');
            select.innerHTML = '<option value="">-- Niveau --</option>';
            const levels = ['6', '5', '4', '3', 'Autre']; 

            levels.forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = `Niveau ${level}`;
                if (level === selectedLevel) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
        function renderCourseSequenceSelect(selectedSequenceName = '') {
            const level = document.getElementById('courseLevelSelect').value;
            const select = document.getElementById('courseSequenceSelect');
            select.innerHTML = '<option value="">-- S√©quence --</option>';
            
            const sessionSelect = document.getElementById('courseSessionSelect');
            sessionSelect.innerHTML = '<option value="">-- S√©ance --</option>';
            
            if (!level) return;

            const sequences = state.sequences[level] || [];
            
            sequences.forEach((seq, idx) => {
                const option = document.createElement('option');
                option.value = idx; 
                option.textContent = seq.name;
                if (seq.name === selectedSequenceName) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            if (selectedSequenceName) {
                renderCourseSessionSelect(null); 
            }
        }
        
        function renderCourseSessionSelect(selectedSessionNum = null) {
            const level = document.getElementById('courseLevelSelect').value;
            const sequenceIdx = document.getElementById('courseSequenceSelect').value;
            const select = document.getElementById('courseSessionSelect');
            select.innerHTML = '<option value="">-- S√©ance --</option>';

            if (!level || sequenceIdx === '') return;

            const sequence = state.sequences[level][sequenceIdx];
            if (!sequence || !sequence.sessions) return;
            
            sequence.sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.sessionNum; 
                option.textContent = `S√©ance ${session.sessionNum}: ${session.name}`;
                if (session.sessionNum == selectedSessionNum) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
       function applySessionContent() {
    const level = document.getElementById('courseLevelSelect').value;
    const sequenceIdx = document.getElementById('courseSequenceSelect').value;
    const sessionNum = document.getElementById('courseSessionSelect').value;

    if (!level || sequenceIdx === '' || !sessionNum) return;
    
    const sequence = state.sequences[level][sequenceIdx];
    const session = sequence.sessions.find(s => s.sessionNum == sessionNum);
    
    if (session) {
        // --- MISE √Ä JOUR POUR QUILL ---
        // On v√©rifie si les √©diteurs contiennent d√©j√† quelque chose.
        // On utilise .getText().trim() pour voir s'il y a du vrai texte (pas juste des balises HTML vides)
        const hasContent = courseContentEditor.getText().trim() !== "";
        const hasHomework = courseHomeworkEditor.getText().trim() !== "";

        if (hasContent || hasHomework) {
            const confirmOverwrite = confirm("Cette s√©ance contient d√©j√† du texte. Voulez-vous remplacer votre saisie par le contenu type de la s√©quence ?");
            if (!confirmOverwrite) {
                document.getElementById('courseSessionNum').value = session.sessionNum;
                return; 
            }
        }

        // --- INJECTION DU CONTENU DANS QUILL ---
        // On utilise .root.innerHTML pour injecter le HTML riche (gras, couleurs, puces)
        courseContentEditor.root.innerHTML = session.content || "";
        courseHomeworkEditor.root.innerHTML = session.homework || "";
        
        document.getElementById('courseSessionNum').value = session.sessionNum;
    }
}
        // =========================================================
        // FONCTIONS D'√âDITION ET DE SAUVEGARDE DE COURS
        // =========================================================

        function editCourse(key, week, slotNum, globalNum) {
    currentEditingCourse = key;
    const course = state.courses[key] || {};
    
    // Champs classiques
    document.getElementById('courseDate').value = course.date || '';
    document.getElementById('courseNotes').value = course.notes || '';
    document.getElementById('courseSessionNum').value = course.sessionNum || 1;
    
    // --- CORRECTION POUR QUILL ---
    // On remplace le .innerHTML par l'acc√®s aux objets Quill
    if (courseContentEditor) {
        courseContentEditor.root.innerHTML = course.content || '';
    }
    if (courseHomeworkEditor) {
        courseHomeworkEditor.root.innerHTML = course.homework || '';
    }
    // -----------------------------
    
    // 1. D√©terminer le Niveau actuel de la classe 
    const currentClassId = state.currentClass;
    const currentLevel = currentClassId.split('-')[0]; // Ex: '3-3' -> '3'

    // 2. Initialiser la s√©lection de Niveau
    renderCourseLevelSelect(currentLevel);
    
    // 3. Initialiser les s√©lections de S√©quence et S√©ance si elles sont d√©j√† dans le cours
    if (course.sequence) {
        const sequenceArray = state.sequences[currentLevel] || [];
        const sequence = sequenceArray.find(s => s.name === course.sequence);
        
        if (sequence) {
            const sequenceIdx = sequenceArray.indexOf(sequence);
            
            document.getElementById('courseLevelSelect').value = currentLevel;
            renderCourseSequenceSelect(course.sequence); 
            document.getElementById('courseSequenceSelect').value = sequenceIdx; 
            
            renderCourseSessionSelect(course.sessionNum);
        }
    } else {
        renderCourseSequenceSelect(); 
    }
    
    // On affiche la modal
    document.getElementById('courseModal').classList.add('active');
    // Si votre modal utilise style.display au lieu d'une classe CSS, utilisez la ligne suivante :
    // document.getElementById('courseModal').style.display = 'block';
}
        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('active');
            currentEditingCourse = null;
        }

function saveCourse() {
    if (!currentEditingCourse) return;
    
    // 1. On r√©cup√®re les valeurs des menus d√©roulants
    const sequenceIdx = document.getElementById('courseSequenceSelect').value;
    const level = document.getElementById('courseLevelSelect').value;
    let sequenceName = '';
    
    if (level && sequenceIdx !== '' && state.sequences[level]) {
        const sequence = state.sequences[level][sequenceIdx];
        if (sequence) sequenceName = sequence.name;
    }
    
    // --- CORRECTION POUR QUILL ICI ---
    // On ne r√©cup√®re plus via document.getElementById(...).innerHTML
    // On demande √† l'objet Quill son contenu HTML
    const content = courseContentEditor.root.innerHTML;
    const homework = courseHomeworkEditor.root.innerHTML;
    // ---------------------------------
    
    const sessionNum = parseInt(document.getElementById('courseSessionNum').value, 10) || 1;
    
    // 2. On met √† jour l'objet global 'state'
    state.courses[currentEditingCourse] = {
        date: document.getElementById('courseDate').value,
        sequence: sequenceName, 
        sessionNum: sessionNum, 
        content: content,  // Sauvegarde le HTML de Quill (gras, couleurs, listes)
        homework: homework, 
        notes: document.getElementById('courseNotes').value
    };

    // 3. Sauvegarde Firebase
    if (userId) {
        console.log("Lancement de la sauvegarde globale via saveData...");
        saveData(); 
        renderCalendar();
        closeCourseModal();
    } else {
        alert("Vous n'√™tes pas connect√© !");
    }
}
        function editWeekNotes(key, week) {
            currentEditingWeek = key;
            const notes = state.weekNotes[key] || '';
            document.getElementById('weekNotes').value = notes;
            document.getElementById('notesModal').classList.add('active');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('active');
            currentEditingWeek = null;
        }
function saveWeekNotes() {
    if (!currentEditingWeek || !userId) return;
    
    // 1. On met √† jour le texte dans l'objet global
    state.weekNotes[currentEditingWeek] = document.getElementById('weekNotes').value;

    // 2. On utilise votre fonction globale qui marche
    saveData(); 

    // 3. On ferme la fen√™tre
    renderCalendar();
    document.getElementById('notesModal').classList.remove('active');
}
        
        
        // =========================================================
        // NOUVELLES FONCTIONS DE GESTION DES S√âQUENCES CENTRALIS√âES
        // =========================================================

        function openSequenceManager() {
            // Afficher la liste de tous les niveaux et s√©quences
            renderSequenceLevelList(); 
            // R√©initialiser le formulaire d'ajout
            closeSequenceManager(false); // On ne ferme que la modale si 'false' est pass√©
            document.getElementById('sequenceModal').classList.add('active');
        }

       function closeSequenceManager(closeModal = true) {
    if (closeModal) {
        document.getElementById('sequenceModal').classList.remove('active');
    }
    
    const nameField = document.getElementById('sequenceName');
    const levelField = document.getElementById('sequenceLevel');
    
    if (nameField) nameField.value = '';
    if (levelField) levelField.value = '';
    
    // R√©initialiser les variables d'√©tat temporaires
    tempSessions = [];
    currentEditingSequenceIndex = null;
    currentEditingLevel = null;
    
    // On rafra√Æchit l'affichage des sessions (qui sera vide puisque tempSessions est vide)
    renderSequenceSessions(); 
}
        
        function renderSequenceLevelList() {
    const list = document.getElementById('sequenceList'); 
    if (!list) return;

    // On r√©cup√®re le niveau s√©lectionn√© dans le menu d√©roulant
    const selectedLevelField = document.getElementById('sequenceLevel');
    const selectedLevel = selectedLevelField ? selectedLevelField.value : "";
    
    list.innerHTML = '';
    let totalSequences = 0;

    // Logique : si un niveau est choisi, on ne regarde que celui-l√†. Sinon, on affiche tout.
    const levelsToDisplay = selectedLevel ? [selectedLevel] : ['6', '5', '4', '3', 'Autre'];

    levelsToDisplay.forEach(level => {
        const sequences = state.sequences[level] || [];
        
        if (sequences.length > 0) {
            // On affiche le titre du niveau
            list.innerHTML += `<h4 style="margin-top: 15px; color: #667eea; border-bottom: 1px solid #eee; padding-bottom: 5px;">Niveau ${level}</h4>`;
            
            sequences.forEach((seq, idx) => {
                totalSequences++;
                list.innerHTML += `
                    <div class="sequence-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dotted #eee;">
                        <div>
                            <strong>${seq.name}</strong>
                            <div style="font-size: 0.85em; color: #6c757d;">${seq.sessions.length} s√©ances</div>
                        </div>
                        <div class="sequence-actions">
                            <button type="button" class="btn-small edit-btn" onclick="editSequence('${level}', ${idx})" style="background: #ffc107; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">‚úèÔ∏è</button>
                            <button type="button" class="btn-small btn-delete" onclick="deleteSequence('${level}', ${idx})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
        }
    });

    if (totalSequences === 0) {
        list.innerHTML = `<div style="color: #999; text-align: center; padding: 20px;">
            ${selectedLevel ? 'Aucune s√©quence pour ce niveau.' : 'Le catalogue est vide.'}
        </div>`;
    }
}
        
        function addSessionToSequence() {
            const nextNum = tempSessions.length + 1;
            tempSessions.push({
                sessionNum: nextNum,
                name: "",
                content: "",
                homework: ""
            });
            renderSequenceSessions();
        }

        function removeSessionFromSequence(index) {
            if(confirm("Supprimer cette s√©ance du catalogue ?")) {
                tempSessions.splice(index, 1);
                // On r√©indexe les num√©ros
                tempSessions.forEach((s, i) => s.sessionNum = i + 1);
                renderSequenceSessions();
            }
        }

        function onSessionSelectChange(selectElement) {
            const sessionName = selectElement.value;
            const sequenceId = document.getElementById('courseSequence').value;
            
            if (!sessionName || !sequenceId) return;

            const sequence = sequences.find(s => s.id === sequenceId);
            if (sequence && sequence.sessions) {
                const sessionData = sequence.sessions.find(s => s.name === sessionName);
                if (sessionData) {
                    const contentDiv = document.getElementById('courseContent');
                    const homeworkDiv = document.getElementById('courseHomework');

                    // On demande confirmation si les champs ne sont pas vides
                    if (contentDiv.textContent.trim() !== "" && !confirm("√âcraser le contenu actuel par celui du catalogue ?")) return;

                    contentDiv.innerHTML = sessionData.content || "";
                    homeworkDiv.innerHTML = sessionData.homework || "";
                }
            }
        }
        
        function renderSequenceSessions() {
    const list = document.getElementById('sequenceSessionsList');
    if (!list) return;

    list.innerHTML = ""; // Vider la liste avant de reconstruire

    if (tempSessions.length === 0) {
        list.innerHTML = '<div style="color: #999; padding: 20px; text-align: center;">Aucune s√©ance d√©finie pour cette s√©quence.</div>';
        return;
    }

    tempSessions.forEach((session, index) => {
        const card = document.createElement('div');
        card.className = "session-card";
        card.innerHTML = `
            <div class="session-card-header">
                <strong>S√©ance ${session.sessionNum}</strong>
                <button type="button" class="btn-small btn-delete" onclick="removeSessionFromSequence(${index})">Supprimer</button>
            </div>
            
            <div class="form-group">
                <label>Titre de la s√©ance</label>
                <input type="text" value="${session.name || ''}" 
                       oninput="tempSessions[${index}].name = this.value" 
                       placeholder="Ex: Introduction aux fonctions">
            </div>

            <div class="form-group">
                <label>Contenu p√©dagogique par d√©faut</label>
                <div id="editor-content-${index}" class="quill-editor-container"></div>
            </div>

            <div class="form-group">
                <label>Travail √† faire par d√©faut</label>
                <div id="editor-homework-${index}" class="quill-editor-container"></div>
            </div>
        `;
        list.appendChild(card);

        // Configuration commune de la barre d'outils (Toolbar)
        // Ajout de 'underline' et 'clean' (pour nettoyer le texte)
       
        // Initialisation Quill pour le Contenu
        const qContent = new Quill(`#editor-content-${index}`, {
            theme: 'snow',
            modules: { toolbar: fullToolbarOptions }
        });
        qContent.root.innerHTML = session.content || "";
        qContent.on('text-change', () => {
            tempSessions[index].content = qContent.root.innerHTML;
        });

        // Initialisation Quill pour les Devoirs
        const qHomework = new Quill(`#editor-homework-${index}`, {
            theme: 'snow',
            modules: { toolbar: fullToolbarOptions }
        });
        qHomework.root.innerHTML = session.homework || "";
        qHomework.on('text-change', () => {
            tempSessions[index].homework = qHomework.root.innerHTML;
        });
    });
}

        function deleteSession(index) {
            if (confirm("Supprimer cette s√©ance ?")) {
                tempSessions.splice(index, 1);
                // R√©ajuster les num√©ros apr√®s suppression
                tempSessions.forEach((s, i) => s.sessionNum = i + 1);
                renderSequenceSessions();
            }
        }
        
        function addSequence() {
    // 1. On bloque le bouton pour √©viter les clics multiples
    const saveBtn = document.querySelector('#sequenceForm .save-btn') || document.querySelector('.save-btn');
    if (saveBtn && saveBtn.disabled) return; 
    if (saveBtn) saveBtn.disabled = true;

    const name = document.getElementById('sequenceName').value.trim();
    const level = document.getElementById('sequenceLevel').value;

    // Validation
    if (!name || !level) {
        alert('Veuillez entrer un nom et choisir un niveau pour la s√©quence.');
        if (saveBtn) saveBtn.disabled = false;
        return;
    }

    if (tempSessions.length === 0) {
        if (!confirm("Attention : Vous n'avez ajout√© aucune s√©ance. Continuer ?")) {
            if (saveBtn) saveBtn.disabled = false;
            return;
        }
    }

    // Mise √† jour du state
    if (!state.sequences[level]) state.sequences[level] = [];
    
    const newSequence = {
        name: name,
        level: level,
        sessions: tempSessions 
    };
    
    if (currentEditingSequenceIndex !== null && currentEditingLevel === level) {
        state.sequences[level][currentEditingSequenceIndex] = newSequence;
    } else {
        if (currentEditingSequenceIndex !== null && currentEditingLevel) {
            state.sequences[currentEditingLevel].splice(currentEditingSequenceIndex, 1);
        }
        state.sequences[level].push(newSequence);
    }
    
    // SAUVEGARDE
    saveData();
    
    // UNE SEULE ALERTE ICI
    alert(`S√©quence "${name}" sauvegard√©e pour le niveau ${level}.`);

    // NETTOYAGE APR√àS LE "OK"
    setTimeout(() => {
     // On r√©initialise l'interface
        closeSequenceManager(false); 
        renderSequenceLevelList();
     // √Ä ajouter √† la fin de addSequence()
        renderFilteredSequences();

        const sessionsList = document.getElementById('sequenceSessionsList');
        if (sessionsList) {
            sessionsList.innerHTML = '<div style="color: #999; text-align: center;">Aucune s√©ance.</div>';
        }
        
        // On d√©bloque le bouton pour la prochaine fois
        if (saveBtn) saveBtn.disabled = false;
    }, 100);
}
        
        function editSequence(level, index) {
            const sequence = state.sequences[level][index];
            if (!sequence) return;
            
            // Fermer/r√©initialiser l'√©tat actuel pour passer en mode √©dition
            closeSequenceManager(false); 

            currentEditingSequenceIndex = index;
            currentEditingLevel = level;
            
            document.getElementById('sequenceName').value = sequence.name;
            document.getElementById('sequenceLevel').value = sequence.level;
            
            // Cloner les sessions dans le tableau temporaire pour l'√©dition
            tempSessions = JSON.parse(JSON.stringify(sequence.sessions)); 
            
            renderSequenceSessions();
        }
        
        function deleteSequence(level, index) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer la s√©quence "${state.sequences[level][index].name}" pour le niveau ${level} ?`)) {
                state.sequences[level].splice(index, 1);
                saveData();
                renderSequenceLevelList();
                }
        }


        // =========================================================
        // Gestion des classes
        // =========================================================
        
        function openClassManager() {
            if (!state.classes) {
                state.classes = [];
            }
            renderClassList();
            document.getElementById('classModal').classList.add('active');
        }

        function closeClassManager() {
            document.getElementById('classModal').classList.remove('active');
            document.getElementById('className').value = '';
        }

        function addClass() {
            const name = document.getElementById('className').value.trim();
            if (!name) {
                alert('Veuillez entrer un nom de classe');
                return;
            }
            
            const pattern = document.querySelector('input[name="weekPattern"]:checked').value;
            // Cr√©ation d'un ID robuste (ex: '3-3' ou '4-1')
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            
            if (state.classes.find(c => c.id === id)) {
                alert('Cette classe existe d√©j√†');
                return;
            }
            
            state.classes.push({
                id: id,
                name: name,
                pattern: pattern
            });
            
            if (!state.currentClass) {
                state.currentClass = id;
            }
            
            saveData();
            updateClassSelect();
            renderClassList();
            
            document.getElementById('className').value = '';
        }

        function renderClassList() {
            const list = document.getElementById('classList');
            
            if (!state.classes || state.classes.length === 0) {
                list.innerHTML = '<div class="empty-state">Aucune classe d√©finie</div>';
                return;
            }
            
            list.innerHTML = state.classes.map((cls, idx) => {
                const [coursesA, coursesB] = cls.pattern.split('-');
                return `
                    <div class="class-item">
                        <div class="class-info">
                            <div class="class-name">${cls.name}</div>
                            <div class="class-pattern">Semaine A: ${coursesA} cours | Semaine B: ${coursesB} cours</div>
                        </div>
                        <div class="sequence-actions">
                            <button class="btn-small btn-delete" onclick="deleteClass(${idx})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteClass(idx) {
            if (state.classes.length === 1) {
                alert('Vous devez avoir au moins une classe');
                return;
            }
            
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette classe ? Toutes les donn√©es associ√©es seront perdues.')) {
                const deletedId = state.classes[idx].id;
                state.classes.splice(idx, 1);
                
                if (state.currentClass === deletedId) {
                    state.currentClass = state.classes.length > 0 ? state.classes[0].id : '';
                }
                
                saveData();
                updateClassSelect();
                renderClassList();
                renderCalendar();
            }
        }
        
        // =========================================================
        // Export/Import
        // =========================================================
        
        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `classeur-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) {
                alert('Veuillez s√©lectionner un fichier');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm('Cette action remplacera toutes vos donn√©es actuelles. Continuer ?')) {
                        // V√©rification de base de la structure des donn√©es
                        if (imported.classes && Array.isArray(imported.classes)) {
                            state = imported;
                            saveData();
                            updateClassSelect();
                            renderCalendar();
                            closeExportModal();
                            alert('Donn√©es import√©es avec succ√®s !');
                        } else {
                            alert('Erreur lors de l\'import : Le fichier ne semble pas √™tre un fichier de donn√©es valide.');
                        }
                    }
                } catch (error) {
                    alert('Erreur lors de l\'import : Fichier invalide ou corrompu.');
                }
            };
            reader.readAsText(file);
        }
// =========================================================
// FONCTION : R√©initialisation Annuelle (CORRIG√âE)
// =========================================================

function resetData() {
    // AJOUT DE L'ALERTE DE CONFIRMATION AVANT D'AGIR
    if (!confirm("ATTENTION : √ätes-vous s√ªr de vouloir r√©initialiser l'ann√©e scolaire ? Cela effacera toutes les classes, notes de cours et notes hebdomadaires. Cette action est irr√©versible !")) {
        // Si l'utilisateur clique sur "Annuler", on sort de la fonction
        return;
    }
    
    // Si l'utilisateur clique sur "OK", on continue
    
    // R√©initialisation des donn√©es sp√©cifiques √† l'ann√©e scolaire
    state.currentClass = '';
    state.currentPeriod = 1;
    state.classes = [];
    state.courses = {}; 
    state.weekNotes = {};
    
    // NOTE : state.sequences n'est pas touch√©.

    // Sauvegarde imm√©diate de l'√©tat r√©initialis√© sur Firebase (avec le bon set())
    saveData(); 
    
    // Recharger l'interface pour afficher l'√©tat vide
    init();
    
    alert("L'ann√©e scolaire a √©t√© r√©initialis√©e. Votre catalogue de s√©quences est conserv√©.");
}
        // D√©marrer l'application
        init();
    
    // =========================================================
// AUTHENTIFICATION
// =========================================================

function signIn() {
    const email = document.getElementById('auth-email').value;
    const password = document.getElementById('auth-password').value;
    
    auth.signInWithEmailAndPassword(email, password)
        .catch(function(error) {
            alert("Erreur de connexion : " + error.message);
        });
}

function signUp() {
    const email = document.getElementById('auth-email').value;
    const password = document.getElementById('auth-password').value;
    
    if (password.length < 6) {
        alert("Le mot de passe doit contenir au moins 6 caract√®res.");
        return;
    }
    
    auth.createUserWithEmailAndPassword(email, password)
        .catch(function(error) {
            alert("Erreur d'inscription : " + error.message);
        });
}

function signOutUser() {
    auth.signOut();
}
// Fonction pour raccourcir le texte si il est trop long
function truncate(str, n) {
    if (!str) return '';
    return (str.length > n) ? str.substr(0, n - 1) + '...' : str;
}
    // Fonction pour que les boutons du texte enrichi fonctionne
   // Fonction de formatage pour les √©diteurs contenteditable
function formatDoc(command, value = null, targetId = 'courseContent') {
    // Obtenir l'√©l√©ment cible
    const target = document.getElementById(targetId);
    
    if (!target) {
        console.error('√âl√©ment cible introuvable:', targetId);
        return;
    }
    
    // Focus sur l'√©l√©ment avant d'appliquer le formatage
    target.focus();
    
    // Appliquer la commande de formatage
    if (value) {
        document.execCommand(command, false, value);
    } else {
        document.execCommand(command, false, null);
    }
}

// Fonction pour nettoyer le contenu placeholder au premier clic
function clearPlaceholder(elementId) {
    const element = document.getElementById(elementId);
    if (element && element.textContent === 'Cliquez pour ajouter du contenu' || 
        element.textContent === 'Cliquez pour ajouter du travail √† faire') {
        element.textContent = '';
    }
}

        
    </script>

</body>


</html>






