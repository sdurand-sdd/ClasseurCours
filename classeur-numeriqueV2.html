<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classeur Num√©rique</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 2px solid #e9ecef;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            font-size: 0.9em;
            color: #495057;
        }

        select, input[type="date"], input[type="text"], button {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .navigation {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .nav-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        .period-info {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            min-width: 150px;
            text-align: center;
        }

        .content {
            padding: 30px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .week-card {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .week-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .week-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-type {
            background: rgba(255,255,255,0.3);
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .course-slot {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .course-slot:hover {
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.2);
        }

        .notes-slot {
            background: white;
            border: 2px dashed #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fffbf0;
        }

        .notes-slot:hover {
            border-color: #ffa000;
            box-shadow: 0 3px 10px rgba(255, 193, 7, 0.2);
        }

        .notes-slot h4 {
            color: #f57c00;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .course-slot h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .course-date {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .course-content {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .course-homework {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #ffc107;
        }

        .course-notes {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #17a2b8;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-btn {
            background: #dc3545;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .close-btn:hover {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .save-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            margin-top: 10px;
        }

        .sequences-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .sequences-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .sequence-list {
            display: grid;
            gap: 15px;
        }

        .sequence-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sequence-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .btn-edit {
            background: #28a745;
        }

        .btn-edit:hover {
            background: #218838;
        }

        .btn-delete {
            background: #dc3545;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: #e7f3ff;
            border-radius: 12px;
            text-align: center;
        }

        .export-btn {
            background: #28a745;
            margin: 5px;
        }

        .export-btn:hover {
            background: #218838;
        }

        .class-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .class-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .class-info {
            flex: 1;
        }

        .class-name {
            font-weight: 600;
            font-size: 1.1em;
            color: #495057;
        }

        .class-pattern {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Classeur Num√©rique</h1>
            <p>Planification et suivi de cours</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Classe</label>
                <select id="classSelect"></select>
            </div>

            <div class="navigation">
                <button class="nav-btn" id="prevPeriod">‚Üê Pr√©c√©dent</button>
                <div class="period-info" id="periodInfo">P√©riode 1</div>
                <button class="nav-btn" id="nextPeriod">Suivant ‚Üí</button>
            </div>

            <button onclick="openClassManager()">‚öôÔ∏è G√©rer les classes</button>
            <button onclick="openSequenceManager()">üîß G√©rer les s√©quences</button>
            <button onclick="openExportModal()">üíæ Exporter/Importer</button>
        </div>

        <div class="content">
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <!-- Modal pour √©diter un cours -->
   <div id="courseModal" class="modal">
    <div class="modal-content">
        <h3>√âditer le cours</h3>
        <span class="close-button" onclick="closeCourseModal()">&times;</span>
        <form id="courseForm">
            
            <label for="courseSequence">S√©quence (Th√®me)</label>
            <select id="courseSequence" required>
                </select>
            
            <label for="courseSessionNum">Num√©ro de S√©ance dans la s√©quence</label>
            <input type="number" id="courseSessionNum" min="1" value="1" placeholder="Ex: 1, 2, 3..." style="margin-bottom: 15px;">
            <label for="courseDate">Date du cours</label>
            <input type="date" id="courseDate" required>

            <label for="courseContent">Contenu du cours</label>
            <textarea id="courseContent" rows="4"></textarea>

            <label for="courseHomework">Devoirs / √Ä faire</label>
            <textarea id="courseHomework" rows="2"></textarea>

            <label for="courseNotes">Notes personnelles</label>
            <textarea id="courseNotes" rows="2"></textarea>

            <button type="submit" class="btn-primary">Sauvegarder</button>
        </form>
    </div>
</div>

    <!-- Modal pour √©diter les notes de semaine -->
    <div class="modal" id="notesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Notes de la semaine</h2>
                <button class="close-btn" onclick="closeNotesModal()">Fermer</button>
            </div>
            <form id="notesForm">
                <div class="form-group">
                    <label>Notes et remarques</label>
                    <textarea id="weekNotes" placeholder="Ajoutez des notes pour cette semaine..." style="min-height: 200px;"></textarea>
                </div>
                <button type="submit" class="save-btn">üíæ Enregistrer</button>
            </form>
        </div>
    </div>

    <!-- Modal pour g√©rer les classes -->
    <div class="modal" id="classModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gestion des classes</h2>
                <button class="close-btn" onclick="closeClassManager()">Fermer</button>
            </div>
            
            <div class="form-group">
                <label>Nom de la classe</label>
                <input type="text" id="className" placeholder="Ex: 3¬∞3, 4¬∞1, 5¬∞A...">
            </div>
            <div class="form-group">
                <label>Configuration des semaines</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="pattern3-2" name="weekPattern" value="3-2" checked>
                        <label for="pattern3-2">Semaine A: 3 cours / Semaine B: 2 cours</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="pattern2-3" name="weekPattern" value="2-3">
                        <label for="pattern2-3">Semaine A: 2 cours / Semaine B: 3 cours</label>
                    </div>
                </div>
            </div>
            <button onclick="addClass()" class="save-btn">‚ûï Ajouter la classe</button>

            <div class="sequences-section">
                <h3>Classes existantes</h3>
                <div class="class-list" id="classList"></div>
            </div>
        </div>
    </div>

    <!-- Modal pour g√©rer les s√©quences -->
    <div class="modal" id="sequenceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gestion des s√©quences</h2>
                <button class="close-btn" onclick="closeSequenceManager()">Fermer</button>
            </div>
            
            <div class="form-group">
                <label>Nom de la s√©quence</label>
                <input type="text" id="sequenceName" placeholder="Ex: Th√©or√®me de Pythagore">
            </div>
            <div class="form-group">
                <label>Contenu type</label>
                <textarea id="sequenceContent" placeholder="Contenu par d√©faut pour cette s√©quence..."></textarea>
            </div>
            <div class="form-group">
                <label>Travail type</label>
                <textarea id="sequenceHomework" placeholder="Travail par d√©faut pour cette s√©quence..."></textarea>
            </div>
            <button onclick="addSequence()" class="save-btn">‚ûï Ajouter la s√©quence</button>

            <div class="sequences-section">
                <h3>S√©quences existantes</h3>
                <div class="sequence-list" id="sequenceList"></div>
            </div>
        </div>
    </div>

    <!-- Modal Export/Import -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Exporter / Importer les donn√©es</h2>
                <button class="close-btn" onclick="closeExportModal()">Fermer</button>
            </div>
            
            <div class="export-section">
                <h3>Exporter vos donn√©es</h3>
                <p>T√©l√©chargez vos donn√©es pour les sauvegarder ou les transf√©rer.</p>
                <button class="export-btn" onclick="exportData()">üì• T√©l√©charger les donn√©es</button>
            </div>

            <div class="export-section" style="background: #fff3cd; margin-top: 20px;">
                <h3>Importer des donn√©es</h3>
                <p>Restaurez vos donn√©es depuis un fichier pr√©c√©demment export√©.</p>
                <input type="file" id="importFile" accept=".json" style="margin: 10px 0;">
                <button class="export-btn" style="background: #ffc107;" onclick="importData()">üì§ Importer les donn√©es</button>
            </div>
        </div>
    </div>

<script>
    // √âtat de l'application
    let state = {
        currentClass: '',
        currentPeriod: 1,
        classes: [], // Initialisation en tant que tableau vide
        courses: {},
        weekNotes: {},
        sequences: {}
    };

    let currentEditingCourse = null;
    let currentEditingWeek = null;

    // Charger les donn√©es depuis le stockage
    function loadData() {
        const saved = localStorage.getItem('classeurData');
        
        if (saved) {
            try {
                // Tenter de charger les donn√©es sauvegard√©es
                const loadedState = JSON.parse(saved);
                // Fusionner avec l'√©tat par d√©faut pour garantir toutes les cl√©s
                state = { ...state, ...loadedState };
            } catch (e) {
                console.error("Erreur lors du chargement des donn√©es. L'√©tat par d√©faut sera utilis√©.", e);
            }
        }
        
        // CORRECTION DE L'ERREUR 1 : Assurer que state.classes est toujours un tableau
        if (!state.classes || !Array.isArray(state.classes)) {
            state.classes = [];
        }

        // Si aucune classe n'existe, cr√©er des classes par d√©faut
        if (state.classes.length === 0) {
            state.classes = [
                { id: '3-3', name: '3¬∞3', pattern: '3-2' },
                { id: '3-4', name: '3¬∞4', pattern: '3-2' },
                { id: '4-1', name: '4¬∞1', pattern: '3-2' },
                { id: '4-2', name: '4¬∞2', pattern: '3-2' },
                { id: '5-1', name: '5¬∞1', pattern: '3-2' },
                { id: '5-2', name: '5¬∞2', pattern: '3-2' },
                { id: '6-1', name: '6¬∞1', pattern: '3-2' }
            ];
            // D√©finir la classe courante si on vient de cr√©er les classes par d√©faut
            state.currentClass = state.classes[0].id;
        }

        // S'assurer qu'une classe courante est d√©finie si des classes existent mais pas de currentClass
        if (!state.currentClass && state.classes.length > 0) {
            state.currentClass = state.classes[0].id;
        }
    }

    // Sauvegarder les donn√©es
    function saveData() {
        localStorage.setItem('classeurData', JSON.stringify(state));
    }

    // Initialiser l'application
    function init() {
        loadData();
        updateClassSelect();
        updatePeriodInfo();
        renderCalendar();
        updateNavigationButtons();

        // Event listeners
        document.getElementById('classSelect').addEventListener('change', (e) => {
            state.currentClass = e.target.value;
            state.currentPeriod = 1;
            renderCalendar();
            updateNavigationButtons();
            updatePeriodInfo();
            saveData();
        });

        document.getElementById('prevPeriod').addEventListener('click', () => {
            if (state.currentPeriod > 1) {
                state.currentPeriod--;
                renderCalendar();
                updateNavigationButtons();
                updatePeriodInfo();
                saveData();
            }
        });

        document.getElementById('nextPeriod').addEventListener('click', () => {
            if (state.currentPeriod < 9) {
                state.currentPeriod++;
                renderCalendar();
                updateNavigationButtons();
                updatePeriodInfo();
                saveData();
            }
        });

        document.getElementById('courseForm').addEventListener('submit', (e) => {
            e.preventDefault();
            saveCourse();
        });

        document.getElementById('notesForm').addEventListener('submit', (e) => {
            e.preventDefault();
            saveWeekNotes();
        });
    }

    function updateClassSelect() {
        const select = document.getElementById('classSelect');
        select.innerHTML = state.classes.map(c => 
            `<option value="${c.id}">${c.name}</option>`
        ).join('');
        select.value = state.currentClass;
    }

    function getCurrentClass() {
        return state.classes.find(c => c.id === state.currentClass);
    }

    function updatePeriodInfo() {
        document.getElementById('periodInfo').textContent = `P√©riode ${state.currentPeriod}`;
    }

    function updateNavigationButtons() {
        document.getElementById('prevPeriod').disabled = state.currentPeriod === 1;
        document.getElementById('nextPeriod').disabled = state.currentPeriod === 9;
    }

    function getWeekPattern(weekNumber) {
        const currentClass = getCurrentClass();
        if (!currentClass) return { type: 'A', courses: 3 }; // Retour par d√©faut s√©curis√©
        
        // Semaine paire = B, Semaine impaire = A
        const isWeekA = weekNumber % 2 === 1;
        
        // S√©curit√© suppl√©mentaire si le pattern est mal form√©
        const parts = currentClass.pattern ? currentClass.pattern.split('-') : ['3', '2'];
        const [coursesA, coursesB] = parts.map(Number);
        
        return {
            type: isWeekA ? 'A' : 'B',
            courses: isWeekA ? coursesA : coursesB
        };
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        
        // S'assurer qu'il y a des classes √† afficher
        if (state.classes.length === 0) {
            grid.innerHTML = '<div class="empty-state">Veuillez d\'abord ajouter une classe via le bouton "G√©rer les classes".</div>';
            return;
        }

        const startWeek = (state.currentPeriod - 1) * 4 + 1;
        
        for (let week = 0; week < 4; week++) {
            const weekNumber = startWeek + week;
            const weekCard = document.createElement('div');
            weekCard.className = 'week-card';
            
            const pattern = getWeekPattern(weekNumber);
            
            let coursesHTML = '';
            
            // Calculer le num√©ro de cours global
            let globalCourseNum = 0;
            for (let w = 1; w < weekNumber; w++) {
                globalCourseNum += getWeekPattern(w).courses;
            }
            
            for (let i = 0; i < pattern.courses; i++) {
                globalCourseNum++;
                coursesHTML += renderCourseSlot(weekNumber, i + 1, globalCourseNum);
            }
            
            // Si c'est une semaine avec moins de 3 cours, ajouter une case notes
            if (pattern.courses < 3) {
                coursesHTML += renderNotesSlot(weekNumber);
            }
            
            weekCard.innerHTML = `
                <div class="week-header">
                    <span>Semaine ${weekNumber}</span>
                    <span class="week-type">Semaine ${pattern.type} (${pattern.courses} cours)</span>
                </div>
                ${coursesHTML}
            `;
            
            grid.appendChild(weekCard);
        }
    }

    // MODIFICATION DE CETTE FONCTION
    function renderCourseSlot(week, slotNum, globalNum) {
        const key = `${state.currentClass}-W${week}-C${slotNum}`;
        // Utiliser || {} pour garantir que course est un objet m√™me s'il n'existe pas
        const course = state.courses[key] || {}; 
        
        // NOUVEAU : Construire l'affichage de la s√©quence et de la s√©ance
        let sequenceDisplay = '';
        if (course.sequence) {
            sequenceDisplay = `<strong>S√©quence:</strong> ${course.sequence}`;
            if (course.sessionNum > 0) {
                sequenceDisplay += ` (S√©ance ${course.sessionNum})`;
            }
        }
        
        return `
            <div class="course-slot" onclick="editCourse('${key}', ${week}, ${slotNum}, ${globalNum})">
                <h4>Cours ${globalNum}</h4>
                ${course.date ? `<div class="course-date">üìÖ ${formatDate(course.date)}</div>` : '<div class="course-date">‚ö†Ô∏è Date non d√©finie</div>'}
                ${sequenceDisplay ? `<div class="course-content">${sequenceDisplay}</div>` : ''} ${course.content ? `<div class="course-content">${truncate(course.content, 100)}</div>` : '<div class="course-content" style="color: #adb5bd;">Cliquez pour ajouter du contenu</div>'}
                ${course.homework ? `<div class="course-homework"><strong>üìù √Ä faire:</strong> ${truncate(course.homework, 80)}</div>` : ''}
                ${course.notes ? `<div class="course-notes"><strong>üí≠ Notes:</strong> ${truncate(course.notes, 80)}</div>` : ''}
            </div>
        `;
    }

    function renderNotesSlot(week) {
        const key = `${state.currentClass}-W${week}-NOTES`;
        const notes = state.weekNotes[key] || '';
        
        return `
            <div class="notes-slot" onclick="editWeekNotes('${key}', ${week})">
                <h4>üìù Notes de la semaine</h4>
                ${notes ? `<div class="course-content">${truncate(notes, 150)}</div>` : '<div class="course-content" style="color: #999;">Cliquez pour ajouter des notes</div>'}
            </div>
        `;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        // Ajout d'un jour pour corriger le d√©calage UTC/local lors de la cr√©ation d'une date (Date('AAAA-MM-JJ') cr√©e √† minuit UTC)
        date.setDate(date.getDate() + 1); 
        return date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    function truncate(text, length) {
        if (!text) return '';
        return text.length > length ? text.substring(0, length) + '...' : text;
    }

    // MODIFICATION DE CETTE FONCTION
    function editCourse(key, week, slotNum, globalNum) {
        currentEditingCourse = key;
        const course = state.courses[key] || {};
        
        document.getElementById('courseDate').value = course.date || '';
        document.getElementById('courseContent').value = course.content || '';
        document.getElementById('courseHomework').value = course.homework || '';
        document.getElementById('courseNotes').value = course.notes || '';
        
        // NOUVEAU : Lire le num√©ro de s√©ance sauvegard√©, ou 1 par d√©faut
        // Utiliser course.sessionNum || 1 pour initialiser √† 1 si non d√©fini
        document.getElementById('courseSessionNum').value = course.sessionNum || 1; 
        
        // Charger les s√©quences dans le select
        const select = document.getElementById('courseSequence');
        select.innerHTML = '<option value="">-- Choisir une s√©quence --</option>';
        const sequences = state.sequences[state.currentClass] || [];
        sequences.forEach((seq, idx) => {
            const option = document.createElement('option');
            option.value = idx;
            option.textContent = seq.name;
            if (course.sequence === seq.name) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        document.getElementById('courseModal').classList.add('active');
    }

    function closeCourseModal() {
        document.getElementById('courseModal').classList.remove('active');
        currentEditingCourse = null;
    }

    // MODIFICATION DE CETTE FONCTION
    function saveCourse() {
        if (!currentEditingCourse) return;
        
        const sequenceIdx = document.getElementById('courseSequence').value;
        let sequenceName = '';
        let defaultContent = '';
        let defaultHomework = '';
        
        if (sequenceIdx !== '') {
            const sequences = state.sequences[state.currentClass] || [];
            const sequence = sequences[sequenceIdx];
            if (sequence) {
                sequenceName = sequence.name;
                defaultContent = sequence.content || '';
                defaultHomework = sequence.homework || '';
            }
        }
        
        const content = document.getElementById('courseContent').value || defaultContent;
        const homework = document.getElementById('courseHomework').value || defaultHomework;
        
        // NOUVEAU : Lire et valider le num√©ro de s√©ance
        const sessionNumInput = document.getElementById('courseSessionNum').value;
        const sessionNum = parseInt(sessionNumInput, 10);
        
        state.courses[currentEditingCourse] = {
            date: document.getElementById('courseDate').value,
            sequence: sequenceName,
            sessionNum: sessionNum > 0 ? sessionNum : 1, // Sauvegarder le num√©ro de s√©ance (au moins 1)
            content: content,
            homework: homework,
            notes: document.getElementById('courseNotes').value
        };
        
        saveData();
        renderCalendar();
        closeCourseModal();
    }

    function editWeekNotes(key, week) {
        currentEditingWeek = key;
        const notes = state.weekNotes[key] || '';
        document.getElementById('weekNotes').value = notes;
        document.getElementById('notesModal').classList.add('active');
    }

    function closeNotesModal() {
        document.getElementById('notesModal').classList.remove('active');
        currentEditingWeek = null;
    }

    function saveWeekNotes() {
        if (!currentEditingWeek) return;
        
        state.weekNotes[currentEditingWeek] = document.getElementById('weekNotes').value;
        
        saveData();
        renderCalendar();
        closeNotesModal();
    }

    // Gestion des classes
    function openClassManager() {
        // CORRECTION/SECURITE 2 : S'assurer que classes est d√©fini avant de l'utiliser
        if (!state.classes) {
            state.classes = [];
        }
        renderClassList();
        document.getElementById('classModal').classList.add('active');
    }

    function closeClassManager() {
        document.getElementById('classModal').classList.remove('active');
        document.getElementById('className').value = '';
    }

    function addClass() {
        const name = document.getElementById('className').value.trim();
        if (!name) {
            alert('Veuillez entrer un nom de classe');
            return;
        }
        
        const pattern = document.querySelector('input[name="weekPattern"]:checked').value;
        const id = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
        
        // V√©rifier si la classe existe d√©j√†
        if (state.classes.find(c => c.id === id)) {
            alert('Cette classe existe d√©j√†');
            return;
        }
        
        state.classes.push({
            id: id,
            name: name,
            pattern: pattern
        });
        
        if (!state.currentClass) {
            state.currentClass = id;
        }
        
        saveData();
        updateClassSelect();
        renderClassList();
        
        document.getElementById('className').value = '';
    }

    function renderClassList() {
        const list = document.getElementById('classList');
        
        // S√©curit√© suppl√©mentaire si state.classes est undefined (m√™me si loadData devrait le corriger)
        if (!state.classes || state.classes.length === 0) {
            list.innerHTML = '<div class="empty-state">Aucune classe d√©finie</div>';
            return;
        }
        
        list.innerHTML = state.classes.map((cls, idx) => {
            const [coursesA, coursesB] = cls.pattern.split('-');
            return `
                <div class="class-item">
                    <div class="class-info">
                        <div class="class-name">${cls.name}</div>
                        <div class="class-pattern">Semaine A: ${coursesA} cours | Semaine B: ${coursesB} cours</div>
                    </div>
                    <div class="sequence-actions">
                        <button class="btn-small btn-delete" onclick="deleteClass(${idx})">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function deleteClass(idx) {
        if (state.classes.length === 1) {
            alert('Vous devez avoir au moins une classe');
            return;
        }
        
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cette classe ? Toutes les donn√©es associ√©es seront perdues.')) {
            const deletedId = state.classes[idx].id;
            state.classes.splice(idx, 1);
            
            // Si on supprime la classe active, choisir la premi√®re
            if (state.currentClass === deletedId) {
                state.currentClass = state.classes.length > 0 ? state.classes[0].id : '';
            }
            
            saveData();
            updateClassSelect();
            renderClassList();
            renderCalendar();
        }
    }

    // Gestion des s√©quences
    function openSequenceManager() {
        renderSequenceList();
        document.getElementById('sequenceModal').classList.add('active');
    }

    function closeSequenceManager() {
        document.getElementById('sequenceModal').classList.remove('active');
        document.getElementById('sequenceName').value = '';
        document.getElementById('sequenceContent').value = '';
        document.getElementById('sequenceHomework').value = '';
    }

    function addSequence() {
        const name = document.getElementById('sequenceName').value.trim();
        if (!name) {
            alert('Veuillez entrer un nom de s√©quence');
            return;
        }
        
        if (!state.sequences[state.currentClass]) {
            state.sequences[state.currentClass] = [];
        }
        
        state.sequences[state.currentClass].push({
            name: name,
            content: document.getElementById('sequenceContent').value,
            homework: document.getElementById('sequenceHomework').value
        });
        
        saveData();
        renderSequenceList();
        
        document.getElementById('sequenceName').value = '';
        document.getElementById('sequenceContent').value = '';
        document.getElementById('sequenceHomework').value = '';
    }

    function renderSequenceList() {
        const list = document.getElementById('sequenceList');
        const sequences = state.sequences[state.currentClass] || [];
        
        if (sequences.length === 0) {
            list.innerHTML = '<div class="empty-state">Aucune s√©quence d√©finie pour cette classe</div>';
            return;
        }
        
        list.innerHTML = sequences.map((seq, idx) => `
            <div class="sequence-item">
                <div>
                    <strong>${seq.name}</strong>
                    ${seq.content ? `<div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">${truncate(seq.content, 60)}</div>` : ''}
                </div>
                <div class="sequence-actions">
                    <button class="btn-small btn-delete" onclick="deleteSequence(${idx})">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }

    function deleteSequence(idx) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cette s√©quence ?')) {
            state.sequences[state.currentClass].splice(idx, 1);
            saveData();
            renderSequenceList();
        }
    }

    // Export/Import
    function openExportModal() {
        document.getElementById('exportModal').classList.add('active');
    }

    function closeExportModal() {
        document.getElementById('exportModal').classList.remove('active');
    }

    function exportData() {
        const dataStr = JSON.stringify(state, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `classeur-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importData() {
        const file = document.getElementById('importFile').files[0];
        if (!file) {
            alert('Veuillez s√©lectionner un fichier');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (confirm('Cette action remplacera toutes vos donn√©es actuelles. Continuer ?')) {
                    state = imported;
                    saveData();
                    updateClassSelect();
                    renderCalendar();
                    closeExportModal();
                    alert('Donn√©es import√©es avec succ√®s !');
                }
            } catch (error) {
                alert('Erreur lors de l\'import : fichier invalide');
            }
        };
        reader.readAsText(file);
    }

    // D√©marrer l'application
    init();
</script>
</body>
</html>
